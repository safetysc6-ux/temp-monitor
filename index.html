<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Temperature Monitor</title>
    <!-- Load Tailwind CSS for modern styling and responsiveness -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for real-time graphing -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Firebase compatibility libs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        /* Custom styles for the temperature gauge effect and graph container */
        .temp-gauge {
            width: 250px;
            height: 250px;
            line-height: 250px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 
                0 0 0 10px rgba(255, 255, 255, 0.1), /* Outer Glow */
                0 0 25px rgba(0, 0, 0, 0.5) inset; /* Inner Shadow for depth */
            transition: all 0.5s ease-in-out;
            font-family: 'Inter', sans-serif;
            border: 5px solid rgba(255, 255, 255, 0.5); /* Clearer Border */
        }
        .temp-text {
            font-size: 3.5rem;
            font-weight: 800;
        }
        /* Body for full height and smooth dark background */
        body {
            min-height: 100vh;
            background-color: #111827; /* Darker background */
        }

        /* Ensure Canvas is responsive within its container */
        #tempChart {
            max-width: 100%;
            height: auto;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'normal': '#10b981', /* Emerald Green */
                        'pre-alarm': '#fbbf24', /* Amber Yellow - slightly brighter */
                        'alarm': '#ef4444', /* Red */
                        'card-bg': '#1f2937', /* Darker card background */
                        'text-light': '#f3f4f6', /* Light text on dark bg */
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 flex flex-col items-center p-4 text-text-light">

    <!-- Header / Title -->
    <header class="w-full text-center py-6">
        <h1 class="text-4xl font-extrabold text-white tracking-tight">
            Advanced Temperature Monitor ‚öôÔ∏è
        </h1>
        <p class="text-base text-gray-400 mt-2">EV Station Fac1 | Real-time Operational Data</p>
    </header>

    <!-- Main Card Container -->
    <div id="main-card" class="w-full max-w-sm bg-card-bg rounded-2xl shadow-xl p-8 mb-8 border-t-8 border-normal transition duration-500">
        
        <!-- Temperature Gauge Display -->
        <div class="text-center mb-8">
            <div id="gauge" class="temp-gauge text-white bg-normal mx-auto flex items-center justify-center">
                <span id="temp" class="temp-text">-- ¬∞C</span>
            </div>
        </div>

        <!-- Status Indicator and Last Update Time -->
        <div class="space-y-4">
            <div id="status-display" class="w-full text-center py-4 px-4 rounded-xl font-extrabold text-xl text-white bg-normal shadow-lg transition duration-500 transform hover:scale-[1.02]">
                Loading Status...
            </div>
            <div class="flex justify-between text-sm text-gray-400 font-medium pt-2 border-t border-gray-700">
                <span>Last Updated:</span>
                <span id="time" class="font-bold text-gray-300">--</span>
            </div>
        </div>
    </div>
    
    <!-- Real-Time Chart Section -->
    <div class="w-full max-w-lg bg-card-bg rounded-2xl shadow-xl p-6 mb-10 border-t-4 border-gray-700">
        <h3 class="text-2xl font-semibold text-white mb-4 border-b border-gray-700 pb-2">Temperature History Analysis</h3>
        <canvas id="tempChart"></canvas>
        <p class="text-sm text-gray-500 text-center mt-3">Monitoring last 20 time-stamped entries for trends.</p>
    </div>


    <script>
        // --- CONSTANTS & CONFIG ---
        const NORMAL_THRESHOLD = 55.0;      // T < 55.0 is Normal
        const PRE_ALARM_THRESHOLD = 60.0;   // 55.0 <= T < 60.0 is Pre-Alarm
        const MAX_DATA_POINTS = 20;         // Max points to show on chart

        // Colors defined in Tailwind config for consistency
        const NORMAL_COLOR = '#10b981';
        const PRE_ALARM_COLOR = '#fbbf24';
        const ALARM_COLOR = '#ef4444';

        // üî• Firebase Config (from user's original code)
        const firebaseConfig = {
            apiKey: "AIzaSyAFL9qfKIvQv-vX4DMQPzj62PwOZF0hY50",
            authDomain: "temp-monitor-9b43b.firebaseapp.com",
            databaseURL: "https://temp-monitor-9b43b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "temp-monitor-9b43b",
            storageBucket: "temp-monitor-9b43b.firebasestorage.app",
            messagingSenderId: "1035092282955",
            appId: "1:1035092282955:web:c31ffddc53ef5eeb7a07ce",
            measurementId: "G-PHME8S0N1W"
        };

        // --- FIREBASE INITIALIZATION ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const logsRef = db.ref("logs");

        // --- CHART.JS SETUP ---
        const tempChartCtx = document.getElementById('tempChart').getContext('2d');
        let chartGradient;

        // Function to create gradient for the chart background
        function createGradient(chartContext, color) {
            if (!chartContext) return 'rgba(0,0,0,0.1)';
            const gradient = chartContext.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, color.replace(')', ', 0.5)')); // Start: 50% opacity
            gradient.addColorStop(1, color.replace(')', ', 0.05)')); // End: 5% opacity
            return gradient;
        }

        let chartData = {
            labels: [],
            datasets: [{
                label: 'Temperature (¬∞C)',
                data: [],
                borderColor: '#60a5fa', // Default Blue Line
                backgroundColor: chartGradient, // Will be set dynamically
                tension: 0.4, // Smoother curve
                borderWidth: 3,
                fill: true,
                pointRadius: 5,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#60a5fa',
                pointHoverRadius: 8,
            }]
        };

        const chartConfig = {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { 
                        mode: 'index', 
                        intersect: false,
                        backgroundColor: 'rgba(31, 41, 55, 0.9)', // Darker tooltip
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#60a5fa',
                        borderWidth: 1,
                        padding: 10,
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Time (HH:MM:SS)', color: '#9ca3af' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#9ca3af' }
                    },
                    y: {
                        title: { display: true, text: 'Temperature (¬∞C)', color: '#9ca3af' },
                        min: 30, 
                        max: 70, 
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#9ca3af' }
                    }
                }
            }
        };

        const tempChart = new Chart(tempChartCtx, chartConfig);

        // --- HELPER FUNCTION: GET STATUS AND STYLES ---
        function getStatus(temp) {
            let status = { text: "", class: "", borderClass: "", color: '#60a5fa' }; // Default color is a nice blue

            if (temp >= PRE_ALARM_THRESHOLD) { // T >= 60
                status.text = "üö® ALARM CRITICAL (‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ 60¬∞C)";
                status.class = "bg-alarm shadow-alarm/50";
                status.borderClass = "border-alarm";
                status.color = ALARM_COLOR;
            } else if (temp >= NORMAL_THRESHOLD) { // 55 <= T < 60
                status.text = "‚ö†Ô∏è PRE-ALARM WARNING (55¬∞C - 60¬∞C)";
                status.class = "bg-pre-alarm shadow-pre-alarm/50";
                status.borderClass = "border-pre-alarm";
                status.color = PRE_ALARM_COLOR;
            } else { // T < 55
                status.text = "‚úÖ NORMAL OPERATING (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 55¬∞C)";
                status.class = "bg-normal shadow-normal/50";
                status.borderClass = "border-normal";
                status.color = NORMAL_COLOR;
            }
            return status;
        }

        // --- UPDATE UI FUNCTION ---
        function updateUI(temperature, timestamp) {
            const tempEl = document.getElementById("temp");
            const statusEl = document.getElementById("status-display");
            const gaugeEl = document.getElementById("gauge");
            const cardEl = document.getElementById("main-card");
            const timeEl = document.getElementById("time");

            // 1. Update Temperature and Status
            const temp = parseFloat(temperature);
            const status = getStatus(temp);

            tempEl.innerText = temp.toFixed(1) + " ¬∞C";

            // 2. Apply status styles
            statusEl.innerText = status.text;
            statusEl.className = "w-full text-center py-4 px-4 rounded-xl font-extrabold text-xl text-white shadow-lg transition duration-500 transform hover:scale-[1.02] " + status.class;
            
            // 3. Update Gauge and Card color
            gaugeEl.className = "temp-gauge mx-auto flex items-center justify-center text-white transition duration-500 " + status.class;
            cardEl.className = "w-full max-w-sm bg-card-bg rounded-2xl shadow-xl p-8 mb-8 border-t-8 transition duration-500 " + status.borderClass;

            // 4. Update Chart Line and Fill Color based on current status
            tempChart.data.datasets[0].borderColor = status.color;
            tempChart.data.datasets[0].pointBorderColor = status.color;
            tempChart.data.datasets[0].backgroundColor = createGradient(tempChartCtx, status.color);
            tempChart.update();
            
            // 5. Update Time
            // Format timestamp: 2024-01-01T12:30:00 -> 01 Jan 2024 12:30:00
            const date = new Date(timestamp);
            timeEl.innerText = date.toLocaleString('th-TH', { 
                day: '2-digit', month: 'short', year: 'numeric', 
                hour: '2-digit', minute: '2-digit', second: '2-digit' 
            }).replace(' ', ' ');
        }

        // --- UPDATE CHART FUNCTION ---
        function updateChart(data) {
            // Add new data point
            chartData.labels.push(data.timestamp.substring(11, 19)); // Use HH:mm:ss for graph X-axis
            chartData.datasets[0].data.push(data.temperature);

            // Keep only the last MAX_DATA_POINTS
            if (chartData.labels.length > MAX_DATA_POINTS) {
                chartData.labels.shift();
                chartData.datasets[0].data.shift();
            }

            tempChart.update();
        }

        // --- INITIAL DATA FETCH FOR CHART HISTORY ---
        logsRef.limitToLast(MAX_DATA_POINTS).once("value", (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const history = Object.keys(data).map(key => ({
                    timestamp: key,
                    temperature: data[key].temperature
                }));

                // Clear previous data
                chartData.labels = [];
                chartData.datasets[0].data = [];

                history.forEach(d => {
                    chartData.labels.push(d.timestamp.substring(11, 19));
                    chartData.datasets[0].data.push(d.temperature);
                });

                // Get the very last item from history to update the main display and set initial colors
                const lastEntry = history[history.length - 1];
                updateUI(lastEntry.temperature, lastEntry.timestamp);
            }
        });

        // --- REAL-TIME LISTENER (Listens only for new child additions) ---
        logsRef.limitToLast(1).on("child_added", (snapshot) => {
            const timestampKey = snapshot.key;
            const data = snapshot.val();
            
            if (data && data.temperature) {
                const newReading = {
                    timestamp: timestampKey,
                    temperature: data.temperature
                };
                
                // Only update if the data key is not already in the chart (to prevent duplicates during initial load)
                if (!chartData.labels.includes(newReading.timestamp.substring(11, 19))) {
                    updateChart(newReading);
                }
                
                // Always update the main UI with the latest data and dynamic chart colors
                updateUI(newReading.temperature, newReading.timestamp);
            }
        });
    </script>
</body>
</html>